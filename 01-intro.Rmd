# Introduction {#intro}

```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(echo=FALSE,results='asis')
library(knitr)
```
```{css, echo = FALSE}
caption, .caption{
  font-style:italic;
  margin-top:0.5em;
  margin-bottom:0.5em;
  width:99%;
  text-align: left;
}
body{
  font-family: Times-Roman;
  font-size: 11pt;
}
p {line-height: 2em;}
tr:nth-child(even) {background-color: #f2f2f2;}
th {
    background-color: #4CAF50;
    color: black;
}
p {
padding-bottom: 15px;
}

```


Spatial statistical models are broadly applied within the fields of geology, geography, ecology, real estate, and medicine, just to name a few. Spatial statistical models often have two broad goals: 1) to describe how covariates affect a response variable, and 2) to make predictions at unsampled locations. For example, data might be used to fit a model establishing a relationship between elevation and air temperature, and also to make a map of air temperature based on a dense set of predictions. When fitting the model and making predictions, a spatial statistical model uses a covariance matrix composed of autocovariance values that rely on Euclidean distances (from straight lines in two dimensions) among all sites. Distances for stream networks, however, are poorly represented by Euclidean distances because fish and water quality attributes do not move over land but follow the sinuous pattern of the network. To apply traditional spatial statistical modeling techniques, those distances must be accurately represented in a covariance matrix structure for stream networks. This chapter provides an overview of recent research on this topic and a new class of spatial-stream network (SSN) model that is being used for an increasing number of applications.

@Ver:Pete:Theo:spat:2006 and @Cres:Frey:Harc:Smit:spat:2006 initially described new models for stream networks based on moving average constructions. The models used stream distance, which was defined as the shortest distance between two locations computed only along the stream network.  [@Pete:Theo:Ver:supp:2007] provide in-depth discussion on the statistical and ecological consequences of substituting stream distance measures for Euclidean distance. The original work defined a class where the moving average function was termed "tail-up," and further models with a "tail-down" moving average function were described by [@Ver:Pete:Move:2010], and we give further details below.  Both types of models were necessary to cover a range of autocorrelation possibilities, so a variance component approach, combining tail-up, tail-down, and classical geostatistical models based on Euclidean distance, was promoted in @Garr:Mone:Ver:spat:2009, @Pete:Ver:mixe:2010 and @Ver:Pete:Move:2010. Although SSN models are most often used for streams, they can be generalized to other dendritic networks [@Pete:Ver:Isaa:stre:2013].  

Because each stream topology is unique, prior to fitting the SSN models, data are preprocessed to develop distance and weighting matrices in a geographical information system (GIS) using the STARS (Spatial Tools for the Analysis of River Systems) custom toolset [@Pete:Ver:STAR:2014}] for ArcGIS [@ESRI:ArcG:2014]. STARS produces the spatial, topological, and attribute information needed to fit a SSN model using the **SSN** package [@Ver:Pete:Clif:Shah:SSN:2014] with the **R** statistical software [@R:Deve:Core:ALan:2015]. 

New spatial statistical methods were recently developed to fit models to data collected on stream (river) networks [@Ver:Pete:Move:2010]. Stream networks, in our usage, are based on a mathematical topology that represents streams as line segments that converge downstream, or viewed conversely, that create dichotomous branching when moving upstream from an outlet (the most downstream location in the network). A number of packages (including, but not limited to, **geoR** [@Ribe:Digg:geoR:2001], **spatial** [@Vene:Ripl:mode:2002], **geoRglm** [@Chri:Ribe:geoR:2002], **gstat** [@Pebe:mult:2004}],
**fields** [@Fiel:Deve:Team:2006], **spBayes** [@Finl:Bane:Carl:spBa:2007], and **ramps**
[@Smit:Yan:Cowl:unif:2008]) have been written in **R** to fit spatial statistical models that use geostatistical autocovariance functions (based on Euclidean distance), but they are not guaranteed to produce positive-definite covariance matrices when using an alternative distance measure, such as stream distance [@Ver:Pete:Theo:spat:2006]. In this book, we present the **R** package **SSN**, which allows users to fit autocovariance functions developed for stream networks [@Ver:Pete:Move:2010]. These models are unique because they use distance measured along the network, they incorporate flow direction,
and they allow covariance weighting when segments converge (e.g., by volume of flowing water). We develop two classes of covariance models based on moving average constructions that we call the tail-up and tail-down models. These models may also be combined in a mixed model strategy that includes models based on Euclidean distance. Such geostatistical mixed models are important because they can account for
multiple processes of spatial autocorrelation in stream systems, including those that occur within the stream and others that result from the straight-line distances due to the terrestrial environment
[@Ver:Pete:Move:2010]. 

## Motivating Example

Organisms that live in streams and rivers are ectothermic and so temperature profoundly affects their ecology. Concerns about climate change and habitat alteration that degrade thermal environments have led to extensive stream temperature monitoring in previous decades by dozens of natural resources agencies throughout North American and Europe. In the American West, the NorWeST (Northwest Stream Temperature) project has aggregated and organized, from $>$100 natural resource agencies, most of the digital temperature records collected using miniature sensors into a massive online database

http://www.fs.fed.us/rm/boise/AWAE/projects/NorWeST.html

The database hosts $>$200 million hourly temperature recordings measured at $>$20,000 unique stream sites. SSN models have been used with a subset of the data to create prediction maps and develop a consistent set of high-resolution climate scenarios. The project is on-going, but prediction map scenarios at a 1-km resolution have been developed for $>$500,000 kilometers of streams and rivers \@ref(fig:Fig-Blob). Detailed maps of higher resolution are available for download, and an interactive map that allows zooming and panning are available at the NorWeST website. 

```{r, Fig-Blob, out.width='90%', fig.align='center', echo = FALSE, fig.pos = 'h', fig.cap='a) Locations of temperature records measured with sensors at $>$20,000 unique stream sites in the NorWeST database, where the blue lines are streams, and the solid black circles are locations. b) Mean August temperature predictions throughout most of the western United States using methods described in this book.'}
knitr::include_graphics('/media/jay/Hitachi2GB/00NMML/ActiveBooks/SpatialStreamNetworks/_bookdown_files/SpatStatStreamNet_files/figure-html/Fig-Blob.png')
```

Based on leave-one-out crossvalidation there was an $r^2$ of 0.90 between true and predicted temperature values at observed sites, with a root-mean-squared prediction error (RMSPE) of 1.0$^0$C across all streams. The accuracy of the SSN temperature model used to develop the scenarios, and the modelâ€™s ability to extract reliable information from large, non-random datasets collected by the management community, has led to the rapid adoption and broad use of NorWeST scenarios for conservation planning. The scenarios have been used to precisely identify climate refugia for cold-water fishes such as trout and char [@Isaa:Youn:Nage:Hora:Groc:2015:cold; @Isaa:Youn:Luce:Host:slow:2016], characterize thermal niches of fish and amphibian species [@Al:Schm:Clan:Saff:Kova:others:brow:2016; @Isaa:Weng:Youn:big:2017], describe how salmon migrations are affected by temperature [@West:Ditt:Ward:Quin:sign:2015], and estimate the distribution and abundance of fish populations [@Dauw:Fese:Bjor:Usin:2015; @Isaa:Ver:Pete:Hora:Nage:scal:2017].

To illustrate statistical methods for stream networks in this Chapter, we use a very small subset of the NorWeST data. The stream network and sampling locations for the example are shown in Figure \@ref(fig:Fig-StudyArea)

```{r, Fig-StudyArea, out.width='70%', fig.align='center', echo = FALSE, include = TRUE, cache = TRUE, fig.pos = 'h', fig.cap="The study area in central Idaho, where average August temperature data were collected from the Middle Fork of the Salmon River in 2004. The sample locations are shown as solid black circles."}
knitr::include_graphics('/media/jay/Hitachi2GB/00NMML/ActiveBooks/SpatialStreamNetworks/_bookdown_files/SpatStatStreamNet_files/figure-html/StudyArea.png')
```

## Why Stream Network Models?

Many researchers have called for using stream distance, rather than Euclidean distance, when developing spatial statistical models for stream networks [@Dent:Grim:spat:1999; @Torg:Gres:Bate:patt:2004; @Yuan:usin:2004]. There is a problem, however, if we simply use stream distance, rather than Euclidean distance, in a standard geostatistical autocovariance model [e.g., a large number geostatistical models based on Euclidean distance can be found in @Chil:Delf:geos:1999, p. 80--97]. To illustrate, we computed stream distances between all pairs of stream locations shown in Figure \@ref(fig:Fig-StudyArea), and then used stream distances (rather than Euclidean distances) in five commonly-used autocovariance models from geostatistics. For all 5 models, the "nugget" effect was set to zero and the "partial sill" was set to 1. The parameter that controls the amount of autocorrelation, often called the "range," was allowed to vary. For each value of the range for each model, a spatial covariance matrix was determined based on stream distance among the 90 locations in Figure \@ref(fig:Fig-StudyArea). The minimum eigenvalue as a function of the range is shown in Figure \@ref(fig:Fig-testEucValid). 

```{r, Fig-testEucValid, out.width='70%', fig.align='center', echo = FALSE, results = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 6, fig.pos = 'h', cache = TRUE, fig.cap="Minimum eigenvalues of spatial covariance matrices for classic geostatistical models based on Euclidean distances, for various range parameters (in log base 2 meters), but when using using stream distance, rather than Euclidean distance, among all locations shown in the Study Area Figure"}
	library(SSN)
	library(maps)
	path1 = '/media/jay/Hitachi2GB/00NMML/ActiveBooks/SpatialStreamNetworks/data/'

	ssn = importSSN(paste0(path1, 'MiddleFork.ssn'),
				 predpts = 'pred1km',o.write = TRUE)
	mf04p = subsetSSN(ssn, paste0(path1,'mf04p.ssn'), 
			subset = SampleYear == 2004)
	createDistMat(mf04p, predpts = 'pred1km')
	ssn = importSSN(paste0(path1,'mf04p.ssn'),
				 predpts = 'pred1km',o.write = TRUE)
	DFL = ssn@data
	DF = getSSNdata.frame(ssn)
	SL = as.SpatialLines(ssn)
	SLDF = as.SpatialLinesDataFrame(ssn)
	SP = as.SpatialPoints(ssn)
	SPDF = as.SpatialPointsDataFrame(ssn)
	distNets = getStreamDistMat(ssn)
	distmat = distNets[[1]]
	ordi = order(as.numeric(rownames(distmat)))
	distmat = distmat[ordi,ordi]
	Ds = distmat + t(distmat)

  nlag = 17
  #Exponential
  mineig1 = NULL
  for(i in 1:nlag) {
    range = 2^i
    CovMat <- exp(-Ds/range)
    mineig1 = c(mineig1,min(eigen(CovMat)$values))
  }
  #Linear
  mineig2 = NULL
  for(i in 1:nlag) {
    range = 2^i
    CovMat <- (1 - Ds/range)
    CovMat[Ds > range] <- 0
    mineig2 = c(mineig2,min(eigen(CovMat)$values))
  }
  #Spherical
  mineig3 = NULL
  for(i in 1:nlag) {
    range = 2^i
    CovMat <- 1 - 1.5*Ds/range + 0.5*(Ds/range)^3
    CovMat[Ds > range] <- 0
    mineig3 = c(mineig3,min(eigen(CovMat)$values))
  }
  #Rational Quadratic
  mineig4 = NULL
  for(i in 1:nlag) {
    range = 2^i
    CovMat = 1/(1+(Ds/range)^2)
    mineig4 = c(mineig4,min(eigen(CovMat)$values))
  }
  #Gaussian
  # 
  mineig5 = NULL
  for(i in 1:nlag) {
    range = 2^i
    CovMat <- exp(-(Ds/range)^2)
    mineig5 = c(mineig5,min(eigen(CovMat)$values))
  }
  par(mar=c(5,5,1,1))
  plot(c(1,nlag),c(-1,1), type = 'n',
    xlab = expression(paste('log'[2],'(range in meters)')), ylab = 'Minimum Eigenvalue',cex.lab = 2,
    cex.axis = 1.5)
  lines(c(1,nlag),c(0,0), lwd = 2, col = 'grey70')
  lines(1:nlag,mineig1, lwd = 4, col = '#e41a1c')
  lines(1:nlag,mineig2, lwd = 4, col = '#4daf4a')
  lines(1:nlag,mineig3, lwd = 4, col = '#377eb8')
  lines(1:nlag,mineig4, lwd = 4, col = '#984ea3')
  lines(1:nlag,mineig5, lwd = 4, col = '#ff7f00')
  legend(1,-0.1,col = c('#e41a1c', '#4daf4a', '#377eb8', '#984ea3', '#ff7f00'), legend = c('Exponential','Linear-with-sill',
    'Spherical','Rational Quadratic','Gaussian'),
    lwd = rep(4, times = 5), cex = 1.7)
```

Notice that negative eigenvalues mean that the covariance matrix is not positive definite, and hence not valid.  Figure \@ref(fig:Fig-testEucValid) demonstrates that the linear-with-sill, rational quadratic, and Gaussian models are not valid when using stream distance for this data set for certain range values.  This illustrates that simple substitution of stream network distance for Euclidean distance does not guarantee valid models, in the sense that the covariance matrix is not guaranteed to be positive definite.  Even when a model appears to be valid for all range values for a given data set, such as the exponential or spherical models in Figure \@ref(fig:Fig-testEucValid), there is no guarantee that additional points, e.g. for prediction purposes, will keep covariance matrices positive definite. Similarly, a change in network configuration could cause these models to fail; indeed, @Ver:Pete:Theo:spat:2006 show a network where the spherical model has negative eigenvalues. Despite this, some researchers continue to erroneously substitute network distance into models designed for geostatistics.  Thus, in order to use stream distance rather than Euclidean distance, another approach is indicated.

Even though substituting stream distance for Euclidean distance does not guarantee valid models, it is fair to ask why use stream distance at all? Fitting SSN models requires more effort than fitting standard geostatistical methods. Calculating stream distances, and weighting stream segments (as we will describe below) requires considerable GIS computation, whereas Euclidean distance can be readily calculated in R (or any software) without a GIS. What is gained by the stream network models? Consider a simple example using the data in Figure \@ref(fig:Fig-StudyArea).  We withheld one measurement, the open circle in Figure \@ref(fig:Fig-whyStreamNet), which also shows its two closest locations (solid circles).

```{r, Fig-whyStreamNet, out.width='70%', fig.align='center', echo = FALSE, results = FALSE, warning = FALSE, message = FALSE, fig.width = 7, fig.height = 7, fig.pos = 'h', cache = TRUE, fig.cap="A comparison of ordinary kriging predictions, using a covariance matrix based on Euclidean distance, and predictions from a stream network model, using a covariance matrix based on stream distance and flow information.  The values at the solid circles are used as observed data to predict the value at the open circle. The real value at the open circle is given, along with predictions for the two models with 90% prediction invervals."}
 xy = list(x = NULL, y = NULL)
  xy$x = -1510200
  xy$y = 2527450
  # remove pid 17, keep 19 and 20
  plot(SL,xlim = c(xy$x-500,xy$x+500), ylim = c(xy$y-500,xy$y+500),
     lwd = .5 + 50*DFL$afvArea, col = 'blue')
  plot(SPDF[c(19,20),], pch = 19, add = TRUE, cex = 2)
#  text(SPDF@coords, as.character(SPDF@data$Summer_mn), pos = 4)
  plot(SPDF[36,], pch = 19, add = TRUE, cex = 2, col = 'white')
  plot(SPDF[36,], pch = 1, add = TRUE, cex = 2)
  text(coordinates(SPDF)[c(19,20,36),], 
    labels = sprintf('%2.1f',
 #   round(as.data.frame(SPDF[c(19,20,36),'Summer_mn'])[,1],1)),
    c(12.3, 15.0, 10.6)),
    cex = 2, pos = 2)
  arrows(x0 = xy$x-250, y0 = xy$y-400, x1 = xy$x-450, y1 = xy$y, lwd = 2)
  text(xy$x-350, xy$y-200, labels = 'flow', cex = 2, pos = 4)
  arrows(x0 = xy$x+200, y0 = xy$y+450, x1 = xy$x-200, y1 = xy$y+450, lwd = 2)
  text(xy$x, xy$y+450, labels = 'flow', cex = 2, pos = 3)
  text(xy$x+300, xy$y-20, labels = 'Euclidean', cex = 2, pos = 3)
  text(xy$x+300, xy$y-50, cex = 2,
    labels=expression(paste("13.1", phantom(.)%+-%phantom(.), "2.74")))
  text(xy$x+300, xy$y-220, labels = 'Stream Network', cex = 2, pos = 3)
  text(xy$x+300, xy$y-250, cex = 2,
    labels=expression(paste("9.4", phantom(.)%+-%phantom(.), "1.75")))
```

 We predicted the withheld observation using ordinary kriging [@Cres:stat:1993] based on Euclidean distance, and also predicted it based on a stream-network model [@Ver:Pete:Move:2010] that we will discuss in greater detail below. Ordinary kriging, based on Euclidean distance, predicted a value for the withheld location of 13.1$^{\circ}$C, with a 90% prediction interval of $\pm$ 2.74$^{\circ}$C. A tail-up stream-network model predicted a lower value of 9.4$^0$C, with a prediction interval of $\pm$ 1.75$^{\circ}$C. Both intervals capture the true value, but the stream network prediction is more accurate. However, there is more of interest. Recall that ordinary kriging generally weights nearby locations most heavily, and the prediction, 13.1, is somewhere between observed values 12.3 and 15.0. From this perspective, the Euclidean model produces a sensible prediction (Figure \@ref(fig:Fig-whyStreamNet)). Yet, this is not logically consistent for a flowing stream. Notice that the temperature decreased from 15.0$^{\circ}$C to 12.3$^{\circ}$C downstream between the two observed locations on the main stream segment (thicker line), even though temperature generally increases while going downstream. This suggests that the unobserved tributary added cold water, causing the drop in temperature. Logically, the downstream temperature of 12.3$^{\circ}$C should be some weighted average of temperatures from the two upstream segments; one with a temperature of 15.0$^{\circ}$C, and while the other temperature is unknown, it is surely less than 12.3$^{\circ}$C. Thus, the ordinary kriging estimate of 13.1$^{\circ}$C is not logically consistent, whereas the estimate from the stream-network model, 9.4$^{\circ}$C, is logically consistent. Although this is but a single prediction, we have observed this type of difference between ordinary kriging and stream network model predictions on many occasions, where the stream network model tends to reflect the topological constraints and the effect of flow on correlation structure. A similar example is given by @Pete:Ver:Isaa:stre:2013.
